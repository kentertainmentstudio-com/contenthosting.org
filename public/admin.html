<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - ContentHosting.org</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3C50E0',
                        secondary: '#80CAEE',
                        stroke: '#E2E8F0',
                        strokedark: '#2E3A47',
                        boxdark: '#24303F',
                        'boxdark-2': '#1A222C',
                        bodydark: '#AEB7C0',
                        bodydark1: '#DEE4EE',
                        bodydark2: '#8A99AF',
                        graydark: '#333A48',
                        whiten: '#F1F5F9',
                        whiter: '#F5F7FD',
                        meta1: '#DC3545',
                        meta2: '#EFF2F7',
                        meta3: '#10B981',
                        meta4: '#313D4A',
                        meta5: '#259AE6',
                    }
                }
            }
        }
    </script>
    <style>
        /* TailAdmin-inspired custom styles */
        .sidebar { transition: width 0.3s ease; }
        .file-item { transition: all 0.2s ease; }
        .file-item:hover { background-color: rgba(60, 80, 224, 0.05); }
        .dark .file-item:hover { background-color: rgba(60, 80, 224, 0.1); }
        .thumbnail { object-fit: cover; }
        .progress-bar { transition: width 0.3s ease; }
        .modal-backdrop { backdrop-filter: blur(4px); }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-track { background: #1A222C; }
        .dark ::-webkit-scrollbar-thumb { background: #313D4A; }
        
        /* Table styles */
        .table-wrapper { overflow-x: auto; }
        
        /* Toast animation */
        .toast-enter { animation: slideIn 0.3s ease; }
        .toast-exit { animation: slideOut 0.3s ease; }
        @keyframes slideIn { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateY(0); opacity: 1; } to { transform: translateY(100%); opacity: 0; } }
    </style>
</head>
<body class="dark bg-boxdark-2 text-bodydark min-h-screen">
    
    <!-- ===== Login Screen ===== -->
    <div id="login-screen" class="flex items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-md">
            <div class="rounded-sm border border-strokedark bg-boxdark shadow-default p-8">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-white mb-2">ContentHosting</h2>
                    <p class="text-bodydark2">Sign in to access the admin panel</p>
                </div>
                
                <form id="login-form" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-bodydark1 mb-2.5">Password</label>
                        <div class="relative">
                            <input 
                                type="password" 
                                id="password" 
                                name="password"
                                placeholder="Enter your password"
                                class="w-full rounded-lg border border-strokedark bg-boxdark-2 py-3 px-4 text-white outline-none focus:border-primary"
                                required
                            >
                            <span class="absolute right-4 top-4">
                                <svg class="fill-bodydark2" width="22" height="22" viewBox="0 0 22 22">
                                    <path d="M16.1547 6.80626V5.91251C16.1547 3.16251 14.0922 0.825009 11.4797 0.618759C10.0359 0.481259 8.59219 0.996884 7.52656 1.95938C6.46094 2.92188 5.84219 4.29688 5.84219 5.70626V6.80626C3.84844 7.18438 2.33594 8.93751 2.33594 11.0688V17.2906C2.33594 19.5594 4.19219 21.3813 6.42656 21.3813H15.5765C17.8109 21.3813 19.6672 19.5251 19.6672 17.2906V11.0688C19.6672 8.93751 18.1547 7.18438 16.1547 6.80626ZM8.55781 5.70626C8.55781 4.98751 8.83281 4.30313 9.34844 3.82501C9.86406 3.34688 10.5828 3.10938 11.3016 3.17813C13.0234 3.34688 14.4359 4.95313 14.4359 6.86251V7.10626H7.55781V5.70626H8.55781ZM18.0391 17.2906C18.0391 18.6375 16.9234 19.7188 15.6109 19.7188H6.46094C5.11406 19.7188 4.03281 18.6031 4.03281 17.2906V11.0688C4.03281 9.75626 5.14844 8.64063 6.46094 8.64063H15.5765C16.8891 8.64063 18.0047 9.72188 18.0047 11.0688V17.2906H18.0391Z"></path>
                                </svg>
                            </span>
                        </div>
                    </div>
                    
                    <div>
                        <button 
                            type="submit"
                            class="w-full rounded-lg bg-primary py-3 px-4 text-white font-medium hover:bg-opacity-90 transition-colors"
                        >
                            Sign In
                        </button>
                    </div>
                    
                    <p id="login-error" class="text-meta1 text-sm text-center hidden">Invalid password</p>
                </form>
            </div>
        </div>
    </div>

    <!-- ===== Admin Panel ===== -->
    <div id="admin-panel" class="hidden">
        <!-- Header -->
        <header class="sticky top-0 z-40 flex w-full bg-boxdark border-b border-strokedark">
            <div class="flex flex-grow items-center justify-between py-4 px-4 md:px-6 2xl:px-11">
                <div class="flex items-center gap-4">
                    <h1 class="text-xl font-bold text-white">ContentHosting</h1>
                    <span class="hidden sm:block text-sm text-bodydark2">File Manager</span>
                </div>
                
                <div class="flex items-center gap-4">
                    <span class="text-sm text-bodydark2" id="file-count-header">0 files</span>
                    <button 
                        id="logout-btn"
                        class="flex items-center gap-2 text-bodydark2 hover:text-white transition-colors"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                        <span class="hidden sm:inline">Logout</span>
                    </button>
                </div>
            </div>
        </header>

        <main class="mx-auto max-w-screen-2xl p-4 md:p-6 2xl:p-10">
            <!-- Upload Card -->
            <div class="rounded-sm border border-strokedark bg-boxdark shadow-default mb-6">
                <div class="border-b border-strokedark py-4 px-6">
                    <h3 class="font-semibold text-white">Upload New File</h3>
                </div>
                <div class="p-6">
                    <form id="upload-form" class="space-y-4">
                        <!-- File Drop Zone -->
                        <div 
                            id="drop-zone"
                            class="border-2 border-dashed border-strokedark rounded-lg p-8 text-center cursor-pointer hover:border-primary transition-colors"
                        >
                            <div id="drop-zone-content">
                                <svg class="mx-auto w-12 h-12 text-bodydark2 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                </svg>
                                <p class="text-bodydark1 mb-2">Drag & drop your file here, or click to browse</p>
                                <p class="text-bodydark2 text-sm">Supported: MP4, WebM, JPG, PNG, GIF (max 500MB)</p>
                            </div>
                            <input 
                                type="file" 
                                id="file-input"
                                accept="video/mp4,video/webm,image/jpeg,image/png,image/gif"
                                class="hidden"
                            >
                        </div>
                        
                        <!-- Selected File Preview -->
                        <div id="file-preview" class="hidden bg-boxdark-2 rounded-lg p-4">
                            <div class="flex items-center gap-4">
                                <div id="preview-thumbnail" class="w-20 h-20 bg-meta4 rounded-lg flex items-center justify-center overflow-hidden">
                                    <!-- Thumbnail will be inserted here -->
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p id="preview-filename" class="text-white font-medium truncate"></p>
                                    <p id="preview-filesize" class="text-bodydark2 text-sm"></p>
                                </div>
                                <button type="button" id="clear-file-btn" class="text-bodydark2 hover:text-meta1 transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div id="progress-container" class="hidden">
                            <div class="flex justify-between text-sm mb-2">
                                <span id="upload-status" class="text-bodydark1">Preparing upload...</span>
                                <span id="upload-percent" class="text-primary">0%</span>
                            </div>
                            <div class="w-full bg-meta4 rounded-full h-2">
                                <div id="progress-bar" class="progress-bar bg-primary h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <!-- Upload Button -->
                        <div class="flex gap-4">
                            <button 
                                type="submit"
                                id="upload-btn"
                                disabled
                                class="inline-flex items-center justify-center gap-2 rounded-lg bg-primary py-3 px-6 font-medium text-white hover:bg-opacity-90 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                </svg>
                                Upload
                            </button>
                        </div>
                    </form>
                    
                    <!-- Upload Success Result -->
                    <div id="upload-result" class="hidden mt-6 bg-boxdark-2 rounded-lg p-4 border border-meta3">
                        <div class="flex items-center gap-2 text-meta3 mb-4">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                            <span class="font-medium">Upload successful!</span>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm text-bodydark2 mb-1 block">Embed URL</label>
                                <div class="flex gap-2">
                                    <input type="text" id="result-url" readonly class="flex-1 rounded bg-boxdark border border-strokedark py-2 px-3 text-white text-sm">
                                    <button onclick="copyToClipboard('result-url', 'URL')" class="rounded bg-meta4 py-2 px-4 text-white text-sm hover:bg-opacity-80 transition-colors">Copy URL</button>
                                </div>
                            </div>
                            <div>
                                <label class="text-sm text-bodydark2 mb-1 block">Embed Code</label>
                                <div class="flex gap-2">
                                    <input type="text" id="result-embed" readonly class="flex-1 rounded bg-boxdark border border-strokedark py-2 px-3 text-white text-sm">
                                    <button onclick="copyToClipboard('result-embed', 'Embed Code')" class="rounded bg-meta4 py-2 px-4 text-white text-sm hover:bg-opacity-80 transition-colors">Copy Embed</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- File Manager Table Card -->
            <div class="rounded-sm border border-strokedark bg-boxdark shadow-default">
                <div class="border-b border-strokedark py-4 px-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                    <h3 class="font-semibold text-white">Uploaded Files</h3>
                    <div class="flex items-center gap-4">
                        <!-- Search Input -->
                        <div class="relative">
                            <input 
                                type="text" 
                                id="search-input"
                                placeholder="Search files..."
                                class="w-full sm:w-64 rounded border border-strokedark bg-boxdark-2 py-2 pl-10 pr-4 text-white text-sm outline-none focus:border-primary"
                            >
                            <svg class="absolute left-3 top-2.5 w-4 h-4 text-bodydark2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                        <!-- Refresh Button -->
                        <button 
                            id="refresh-btn"
                            onclick="loadFileList()"
                            class="flex items-center gap-2 rounded border border-strokedark bg-boxdark-2 py-2 px-4 text-bodydark1 text-sm hover:border-primary hover:text-white transition-colors"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            <span class="hidden sm:inline">Refresh</span>
                        </button>
                    </div>
                </div>
                
                <div class="table-wrapper">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="bg-boxdark-2 text-left">
                                <th class="py-4 px-4 font-medium text-bodydark1">Preview</th>
                                <th class="py-4 px-4 font-medium text-bodydark1">Filename</th>
                                <th class="py-4 px-4 font-medium text-bodydark1 hidden md:table-cell">Type</th>
                                <th class="py-4 px-4 font-medium text-bodydark1 hidden lg:table-cell">Size</th>
                                <th class="py-4 px-4 font-medium text-bodydark1 hidden lg:table-cell">Date</th>
                                <th class="py-4 px-4 font-medium text-bodydark1 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="file-list">
                            <tr>
                                <td colspan="6" class="py-8 text-center text-bodydark2">
                                    <svg class="animate-spin mx-auto w-8 h-8 mb-4" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    Loading files...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div id="pagination" class="hidden border-t border-strokedark py-4 px-6 flex items-center justify-between">
                    <p class="text-sm text-bodydark2">
                        Showing <span id="showing-from">1</span> to <span id="showing-to">10</span> of <span id="total-count">0</span> files
                    </p>
                    <div class="flex gap-2">
                        <button id="prev-btn" disabled class="rounded border border-strokedark py-2 px-3 text-bodydark1 text-sm hover:border-primary disabled:opacity-50 disabled:cursor-not-allowed transition-colors">Previous</button>
                        <button id="next-btn" disabled class="rounded border border-strokedark py-2 px-3 text-bodydark1 text-sm hover:border-primary disabled:opacity-50 disabled:cursor-not-allowed transition-colors">Next</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 modal-backdrop" onclick="closeDeleteModal()"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="relative bg-boxdark rounded-lg shadow-xl max-w-md w-full p-6 border border-strokedark">
                <h3 class="text-lg font-semibold text-white mb-4">Confirm Delete</h3>
                <p class="text-bodydark1 mb-6">Are you sure you want to delete <span id="delete-filename" class="text-white font-medium"></span>? This action cannot be undone.</p>
                <div class="flex justify-end gap-3">
                    <button onclick="closeDeleteModal()" class="rounded border border-strokedark py-2 px-4 text-bodydark1 hover:border-primary hover:text-white transition-colors">Cancel</button>
                    <button id="confirm-delete-btn" class="rounded bg-meta1 py-2 px-4 text-white hover:bg-opacity-90 transition-colors">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <script>
        // ============================================
        // Configuration
        // ============================================
        const API_BASE = '/api';
        const EMBED_BASE = 'https://contenthosting.org/embed';
        const ITEMS_PER_PAGE = 20;
        
        // ============================================
        // State
        // ============================================
        let authToken = localStorage.getItem('auth_token');
        let selectedFile = null;
        let currentPage = 0;
        let totalFiles = 0;
        let searchQuery = '';
        let deleteFileId = null;
        
        // ============================================
        // DOM Elements
        // ============================================
        const loginScreen = document.getElementById('login-screen');
        const adminPanel = document.getElementById('admin-panel');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const uploadForm = document.getElementById('upload-form');
        const fileInput = document.getElementById('file-input');
        const uploadBtn = document.getElementById('upload-btn');
        const dropZone = document.getElementById('drop-zone');
        const dropZoneContent = document.getElementById('drop-zone-content');
        const filePreview = document.getElementById('file-preview');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const uploadStatus = document.getElementById('upload-status');
        const uploadPercent = document.getElementById('upload-percent');
        const uploadResult = document.getElementById('upload-result');
        const fileList = document.getElementById('file-list');
        const searchInput = document.getElementById('search-input');
        const logoutBtn = document.getElementById('logout-btn');
        const clearFileBtn = document.getElementById('clear-file-btn');
        
        // ============================================
        // Initialization
        // ============================================
        if (authToken) {
            showAdminPanel();
        }
        
        // ============================================
        // Authentication
        // ============================================
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(`${API_BASE}/auth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token;
                    localStorage.setItem('auth_token', authToken);
                    loginError.classList.add('hidden');
                    showAdminPanel();
                } else {
                    loginError.classList.remove('hidden');
                }
            } catch (err) {
                console.error('Login error:', err);
                loginError.textContent = 'Connection error. Please try again.';
                loginError.classList.remove('hidden');
            }
        });
        
        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('auth_token');
            authToken = null;
            loginScreen.classList.remove('hidden');
            adminPanel.classList.add('hidden');
        });
        
        function showAdminPanel() {
            loginScreen.classList.add('hidden');
            adminPanel.classList.remove('hidden');
            loadFileList();
        }
        
        // ============================================
        // File Selection & Drag/Drop
        // ============================================
        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-primary', 'bg-primary/5');
        });
        
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-primary', 'bg-primary/5');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-primary', 'bg-primary/5');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });
        
        clearFileBtn.addEventListener('click', () => {
            selectedFile = null;
            fileInput.value = '';
            filePreview.classList.add('hidden');
            uploadBtn.disabled = true;
            uploadResult.classList.add('hidden');
        });
        
        function handleFileSelect(file) {
            const allowedTypes = ['video/mp4', 'video/webm', 'image/jpeg', 'image/png', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                showToast('Invalid file type. Supported: MP4, WebM, JPG, PNG, GIF', 'error');
                return;
            }
            
            const maxSize = 500 * 1024 * 1024;
            if (file.size > maxSize) {
                showToast('File too large. Maximum size is 500MB.', 'error');
                return;
            }
            
            selectedFile = file;
            
            // Update preview
            document.getElementById('preview-filename').textContent = file.name;
            document.getElementById('preview-filesize').textContent = formatFileSize(file.size);
            
            const thumbnail = document.getElementById('preview-thumbnail');
            thumbnail.innerHTML = '';
            
            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.className = 'w-full h-full object-cover';
                img.onload = () => URL.revokeObjectURL(img.src);
                thumbnail.appendChild(img);
            } else if (file.type.startsWith('video/')) {
                thumbnail.innerHTML = `
                    <svg class="w-8 h-8 text-bodydark2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                `;
            }
            
            filePreview.classList.remove('hidden');
            uploadBtn.disabled = false;
            uploadResult.classList.add('hidden');
        }
        
        // ============================================
        // File Upload
        // ============================================
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!selectedFile) return;
            
            uploadBtn.disabled = true;
            progressContainer.classList.remove('hidden');
            uploadResult.classList.add('hidden');
            updateProgress(0, 'Getting upload URL...');
            
            try {
                // Step 1: Get presigned URL
                const presignedResponse = await fetch(`${API_BASE}/presigned-post`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        filename: selectedFile.name,
                        contentType: selectedFile.type,
                        size: selectedFile.size
                    })
                });
                
                if (!presignedResponse.ok) {
                    const err = await presignedResponse.json();
                    throw new Error(err.error || 'Failed to get upload URL');
                }
                
                const { uploadUrl, fileId, b2Key } = await presignedResponse.json();
                
                // Step 2: Upload to B2
                updateProgress(10, 'Uploading to storage...');
                
                await uploadWithProgress(uploadUrl, selectedFile, (progress) => {
                    const totalProgress = 10 + (progress * 0.8);
                    updateProgress(totalProgress, `Uploading... ${Math.round(progress * 100)}%`);
                });
                
                // Step 3: Register in D1
                updateProgress(90, 'Registering file...');
                
                const registerResponse = await fetch(`${API_BASE}/register-upload`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        fileId,
                        filename: selectedFile.name,
                        contentType: selectedFile.type,
                        size: selectedFile.size,
                        b2Key
                    })
                });
                
                if (!registerResponse.ok) {
                    throw new Error('Failed to register file');
                }
                
                updateProgress(100, 'Complete!');
                
                setTimeout(() => {
                    progressContainer.classList.add('hidden');
                    uploadResult.classList.remove('hidden');
                    
                    const embedUrl = `${EMBED_BASE}/${fileId}`;
                    const embedCode = `<iframe src="${embedUrl}" width="100%" height="450" frameborder="0" allowfullscreen></iframe>`;
                    
                    document.getElementById('result-url').value = embedUrl;
                    document.getElementById('result-embed').value = embedCode;
                    
                    // Reset and refresh
                    selectedFile = null;
                    fileInput.value = '';
                    filePreview.classList.add('hidden');
                    loadFileList();
                    
                    showToast('File uploaded successfully!', 'success');
                }, 500);
                
            } catch (err) {
                console.error('Upload error:', err);
                showToast('Upload failed: ' + err.message, 'error');
                progressContainer.classList.add('hidden');
            } finally {
                uploadBtn.disabled = !selectedFile;
            }
        });
        
        function updateProgress(percent, status) {
            progressBar.style.width = `${percent}%`;
            uploadStatus.textContent = status;
            uploadPercent.textContent = `${Math.round(percent)}%`;
        }
        
        function uploadWithProgress(url, file, onProgress) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        onProgress(e.loaded / e.total);
                    }
                });
                
                xhr.addEventListener('load', () => {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        resolve(xhr.response);
                    } else {
                        reject(new Error(`Upload failed with status ${xhr.status}`));
                    }
                });
                
                xhr.addEventListener('error', () => reject(new Error('Upload failed')));
                xhr.addEventListener('abort', () => reject(new Error('Upload aborted')));
                
                xhr.open('PUT', url);
                xhr.setRequestHeader('Content-Type', file.type);
                xhr.send(file);
            });
        }
        
        // ============================================
        // File List
        // ============================================
        let searchTimeout;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchQuery = e.target.value;
                currentPage = 0;
                loadFileList();
            }, 300);
        });
        
        async function loadFileList() {
            fileList.innerHTML = `
                <tr>
                    <td colspan="6" class="py-8 text-center text-bodydark2">
                        <svg class="animate-spin mx-auto w-8 h-8 mb-4" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Loading files...
                    </td>
                </tr>
            `;
            
            try {
                const params = new URLSearchParams({
                    limit: ITEMS_PER_PAGE,
                    offset: currentPage * ITEMS_PER_PAGE
                });
                if (searchQuery) params.append('search', searchQuery);
                
                const response = await fetch(`${API_BASE}/list-files?${params}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to load files');
                
                const data = await response.json();
                totalFiles = data.total;
                
                document.getElementById('file-count-header').textContent = `${totalFiles} file${totalFiles !== 1 ? 's' : ''}`;
                
                if (data.files.length === 0) {
                    fileList.innerHTML = `
                        <tr>
                            <td colspan="6" class="py-8 text-center text-bodydark2">
                                ${searchQuery ? 'No files match your search' : 'No files uploaded yet'}
                            </td>
                        </tr>
                    `;
                    document.getElementById('pagination').classList.add('hidden');
                    return;
                }
                
                fileList.innerHTML = data.files.map(file => createFileRow(file)).join('');
                
                // Update pagination
                const pagination = document.getElementById('pagination');
                const from = currentPage * ITEMS_PER_PAGE + 1;
                const to = Math.min((currentPage + 1) * ITEMS_PER_PAGE, totalFiles);
                
                document.getElementById('showing-from').textContent = from;
                document.getElementById('showing-to').textContent = to;
                document.getElementById('total-count').textContent = totalFiles;
                
                document.getElementById('prev-btn').disabled = currentPage === 0;
                document.getElementById('next-btn').disabled = to >= totalFiles;
                
                pagination.classList.remove('hidden');
                
            } catch (err) {
                console.error('Load files error:', err);
                fileList.innerHTML = `
                    <tr>
                        <td colspan="6" class="py-8 text-center text-meta1">Failed to load files</td>
                    </tr>
                `;
            }
        }
        
        function createFileRow(file) {
            const isVideo = file.contentType.startsWith('video/');
            const isImage = file.contentType.startsWith('image/');
            const embedUrl = `${EMBED_BASE}/${file.fileId}`;
            const embedCode = `<iframe src="${embedUrl}" width="100%" height="450" frameborder="0" allowfullscreen></iframe>`;
            const date = new Date(file.uploadDate).toLocaleDateString();
            const size = formatFileSize(file.size);
            const typeLabel = file.contentType.split('/')[1].toUpperCase();
            
            // Thumbnail
            let thumbnail;
            if (isImage && file.thumbnailUrl) {
                thumbnail = `<img src="${file.thumbnailUrl}" class="w-12 h-12 rounded object-cover" alt="${escapeHtml(file.filename)}" loading="lazy">`;
            } else if (isVideo) {
                thumbnail = `
                    <div class="w-12 h-12 rounded bg-meta4 flex items-center justify-center">
                        <svg class="w-6 h-6 text-bodydark2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                `;
            } else {
                thumbnail = `
                    <div class="w-12 h-12 rounded bg-meta4 flex items-center justify-center">
                        <svg class="w-6 h-6 text-bodydark2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </div>
                `;
            }
            
            return `
                <tr class="file-item border-b border-strokedark">
                    <td class="py-4 px-4">${thumbnail}</td>
                    <td class="py-4 px-4">
                        <p class="text-white font-medium truncate max-w-[200px]">${escapeHtml(file.filename)}</p>
                        <p class="text-bodydark2 text-sm md:hidden">${typeLabel} â€¢ ${size}</p>
                    </td>
                    <td class="py-4 px-4 hidden md:table-cell">
                        <span class="inline-flex rounded-full bg-primary/10 py-1 px-3 text-sm text-primary">${typeLabel}</span>
                    </td>
                    <td class="py-4 px-4 text-bodydark1 hidden lg:table-cell">${size}</td>
                    <td class="py-4 px-4 text-bodydark1 hidden lg:table-cell">${date}</td>
                    <td class="py-4 px-4">
                        <div class="flex items-center justify-end gap-2">
                            <button 
                                onclick="copyToClipboard(null, 'URL', '${embedUrl}')"
                                class="rounded border border-strokedark p-2 text-bodydark2 hover:border-primary hover:text-primary transition-colors"
                                title="Copy URL"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                                </svg>
                            </button>
                            <button 
                                onclick="copyToClipboard(null, 'Embed Code', '${escapeHtml(embedCode).replace(/"/g, '&quot;')}')"
                                class="rounded border border-strokedark p-2 text-bodydark2 hover:border-primary hover:text-primary transition-colors"
                                title="Copy Embed Code"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                                </svg>
                            </button>
                            <button 
                                onclick="openDeleteModal('${file.fileId}', '${escapeHtml(file.filename)}')"
                                class="rounded border border-strokedark p-2 text-bodydark2 hover:border-meta1 hover:text-meta1 transition-colors"
                                title="Delete"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }
        
        // Pagination handlers
        document.getElementById('prev-btn').addEventListener('click', () => {
            if (currentPage > 0) {
                currentPage--;
                loadFileList();
            }
        });
        
        document.getElementById('next-btn').addEventListener('click', () => {
            if ((currentPage + 1) * ITEMS_PER_PAGE < totalFiles) {
                currentPage++;
                loadFileList();
            }
        });
        
        // ============================================
        // Delete Functionality
        // ============================================
        function openDeleteModal(fileId, filename) {
            deleteFileId = fileId;
            document.getElementById('delete-filename').textContent = filename;
            document.getElementById('delete-modal').classList.remove('hidden');
        }
        
        function closeDeleteModal() {
            deleteFileId = null;
            document.getElementById('delete-modal').classList.add('hidden');
        }
        
        document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
            if (!deleteFileId) return;
            
            const btn = document.getElementById('confirm-delete-btn');
            btn.disabled = true;
            btn.textContent = 'Deleting...';
            
            try {
                const response = await fetch(`${API_BASE}/delete-file?id=${deleteFileId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) throw new Error('Delete failed');
                
                showToast('File deleted successfully', 'success');
                closeDeleteModal();
                loadFileList();
                
            } catch (err) {
                console.error('Delete error:', err);
                showToast('Failed to delete file', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Delete';
            }
        });
        
        // ============================================
        // Utilities
        // ============================================
        function copyToClipboard(elementId, label, value) {
            const text = value || document.getElementById(elementId).value;
            navigator.clipboard.writeText(text).then(() => {
                showToast(`${label} copied to clipboard!`, 'success');
            }).catch(() => {
                showToast('Failed to copy to clipboard', 'error');
            });
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const colors = {
                success: 'bg-meta3',
                error: 'bg-meta1',
                info: 'bg-primary'
            };
            
            toast.className = `toast-enter ${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2`;
            toast.innerHTML = `
                ${type === 'success' ? '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>' : ''}
                ${type === 'error' ? '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>' : ''}
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('toast-enter');
                toast.classList.add('toast-exit');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
